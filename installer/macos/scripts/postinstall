#!/bin/bash
# Post-installation script for macOS

APP_DIR="/Applications/GitHub Copilot Office Add-in"
LAUNCHAGENT_SRC="$APP_DIR/com.github.copilot-office-addin.plist"
LAUNCHAGENT_DEST="$HOME/Library/LaunchAgents/com.github.copilot-office-addin.plist"
CERT_PATH="$APP_DIR/certs/localhost.pem"
MANIFEST_PATH="$APP_DIR/manifest.xml"

# Get the installing user (not root)
if [ -n "$USER" ] && [ "$USER" != "root" ]; then
    INSTALL_USER="$USER"
elif [ -n "$SUDO_USER" ]; then
    INSTALL_USER="$SUDO_USER"
else
    INSTALL_USER=$(stat -f "%Su" /dev/console)
fi

USER_HOME=$(dscl . -read /Users/$INSTALL_USER NFSHomeDirectory | awk '{print $2}')

echo "Installing for user: $INSTALL_USER"
echo "User home: $USER_HOME"

# Trust SSL certificate
echo "Trusting SSL certificate..."
security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain "$CERT_PATH" 2>/dev/null || true

# Create LaunchAgents directory if needed
mkdir -p "$USER_HOME/Library/LaunchAgents"

# Install LaunchAgent for the user
LAUNCHAGENT_USER_DEST="$USER_HOME/Library/LaunchAgents/com.github.copilot-office-addin.plist"
cp "$LAUNCHAGENT_SRC" "$LAUNCHAGENT_USER_DEST"
chown $INSTALL_USER:staff "$LAUNCHAGENT_USER_DEST"

# Register add-in with Office apps
WORD_WEF="$USER_HOME/Library/Containers/com.microsoft.Word/Data/Documents/wef"
PPT_WEF="$USER_HOME/Library/Containers/com.microsoft.Powerpoint/Data/Documents/wef"
EXCEL_WEF="$USER_HOME/Library/Containers/com.microsoft.Excel/Data/Documents/wef"

for WEF_DIR in "$WORD_WEF" "$PPT_WEF" "$EXCEL_WEF"; do
    mkdir -p "$WEF_DIR"
    cp "$MANIFEST_PATH" "$WEF_DIR/"
    chown -R $INSTALL_USER:staff "$WEF_DIR"
done

echo "Add-in registered for Word, PowerPoint, and Excel"

# Load the LaunchAgent (as the user, not root)
sudo -u $INSTALL_USER launchctl unload "$LAUNCHAGENT_USER_DEST" 2>/dev/null || true
sudo -u $INSTALL_USER launchctl load "$LAUNCHAGENT_USER_DEST"

echo "Service started"
echo "Installation complete!"

exit 0
